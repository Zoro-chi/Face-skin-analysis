# Face Skin Condition Analysis - Configuration File

project:
  name: "Face Skin Condition Analysis"
  description: "Fair & Explainable Facial Skin Condition Detection"
  version: "1.0.0"

# Environment-specific paths (auto-detected)
# Local: data/raw, data/processed
# Colab: /content/drive/MyDrive/Face-skin-analysis/data/...
environment:
  auto_detect: true # Automatically detect local vs Colab

  # Override paths if needed
  local:
    base_dir: "."
  colab:
    base_dir: "/content/drive/MyDrive/Face-skin-analysis"
    use_local_storage: false # Set true to copy data to /content for faster I/O

data:
  raw_dir: "data/raw"
  processed_dir: "data/processed"
  augmented_dir: "data/augmented"

  # Dataset sources
  datasets:
    - fitzpatrick17k # Priority: has skin tone labels (critical for fairness)
    - acne04 # Priority: acne-specific dataset
    - kaggle_face_skin_diseases # Amellia: face-focused (Acne, Rosacea, etc.)
    - kaggle_skin_defects # TrainingDataPro: acne, redness, eye-bags
    - kaggle_skin_diseases # IsmailPromus: lesion classes (pigmentation proxy)
    # - dermnet       # Commented out: too large, enable if needed
    # - celeba        # Commented out: 405k images, use subset if needed

  # Limit images per dataset (set to null for no limit)
  max_images_per_dataset: 5000 # Process max 5000 images per dataset

  # Skip face detection for pre-aligned or non-facial datasets
  skip_face_detection:
    - celeba # CelebA is already face-aligned
    - fitzpatrick17k # Dermatology dataset - skin lesions, not faces
    - acne04 # Close-ups of acne regions, may not have full detectable faces
    - kaggle_face_skin_diseases # Face-aligned dataset (train/test)
    - kaggle_skin_diseases # Lesion-centric dataset; face detection not applicable

  # Skin tone grouping (Fitzpatrick Scale)
  skin_tones:
    light: [1, 2]
    medium: [3, 4]
    dark: [5, 6]

  # Train/Val/Test split
  split_ratios:
    train: 0.7
    val: 0.15
    test: 0.15

  random_seed: 22

preprocessing:
  # Face detection
  face_detector: "opencv" # Options: opencv, mtcnn, retinaface

  # Image size
  image_size: 224

  # Normalization (ImageNet)
  mean: [0.485, 0.456, 0.406]
  std: [0.229, 0.224, 0.225]

  # CLAHE parameters
  clahe:
    enabled: true
    clip_limit: 2.0
    tile_grid_size: [8, 8]

  # Augmentation
  augmentation:
    horizontal_flip: 0.5
    rotation: 15
    brightness: 0.2
    contrast: 0.2
    saturation: 0.2
    hue: 0.1

model:
  # Model architecture
  architecture: "efficientnet-b3" # Options: efficientnet-b3, vit-base, resnet50
  pretrained: true

  # Multi-label classification
  conditions:
    - acne
    - pigmentation
    - wrinkles

  num_classes: 3

  # Dropout for uncertainty estimation
  dropout_rate: 0.3
  mc_dropout_samples: 20

training:
  # Hyperparameters
  batch_size: 32
  num_epochs: 50
  learning_rate: 0.0001
  weight_decay: 0.0001

  # Loss function
  loss: "weighted_bce" # Use weighted BCE to address class imbalance
  # Suggested weights derived from train split label counts
  # Train positives: acne=113, pigmentation=2939, wrinkles=20 (N=3992)
  # Weights normalized around mean ~1.0
  class_weights: [0.45, 0.02, 2.53]

  # Fairness: Balance skin tone distribution in training batches
  balance_skin_tones: true # Use WeightedRandomSampler to oversample underrepresented groups

  # Optimizer
  optimizer: "adam"
  scheduler: "cosine"

  # Early stopping
  early_stopping:
    enabled: true
    patience: 10
    min_delta: 0.001

  # Checkpointing
  save_best_only: true
  checkpoint_dir: "outputs/checkpoints"

evaluation:
  # Metrics
  metrics:
    - precision
    - recall
    - f1_score
    - auroc

  # Stratified evaluation
  stratify_by_skin_tone: true

  # Confidence threshold
  confidence_threshold: 0.5

  # Optimize per-class thresholds on validation before test evaluation
  optimize_thresholds: true

  # Per-group (skin tone) threshold optimization for fairness
  optimize_per_group_thresholds: true # Optimize thresholds separately for each skin tone

  # Bias metrics
  fairness_metrics:
    - false_negative_rate
    - false_positive_rate
    - equalized_odds

explainability:
  # Grad-CAM configuration
  gradcam:
    target_layer: "features" # Adjust based on model architecture
    colormap: "jet"
    alpha: 0.4 # Overlay transparency

  # Save visualizations
  save_heatmaps: true
  output_dir: "outputs/explainability"

inference:
  # Confidence scoring
  use_mc_dropout: true
  temperature_scaling: true

  # ONNX
  onnx_model_path: "onnx/skin_model.onnx"

  # Output format
  return_heatmap: true
  return_confidence: true

mlops:
  # MLflow
  mlflow:
    tracking_uri: "https://dagshub.com/zoro-chi/face-skin-analysis.mlflow"
    experiment_name: "face-skin-analysis"

  # DVC
  dvc:
    remote: "dagshub"
    cache_dir: ".dvc/cache"

  # DagsHub
  dagshub:
    repo_owner: "zoro-chi"
    repo_name: "face-skin-analysis"

logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  save_logs: true
  log_dir: "outputs/logs"
